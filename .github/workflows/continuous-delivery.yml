name: Continuous Delivery

on:
  push:
    branches:
      - production
      - main
      - develop
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch:
    inputs:
      dryRun:
        description: "Perform a dry run (no actual release)"
        required: false
        default: false
        type: boolean

permissions: write-all

env:
  WORKSPACE: ${{ github.workspace }}

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Version, Changelog, Release
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.release-info.outputs.released }}
      tags: ${{ steps.release-info.outputs.tags }}
      projects: ${{ steps.release-info.outputs.projects }}
    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.OPERATOR_GITHUB_APPLICATION_ID }}
          private-key: ${{ secrets.OPERATOR_GITHUB_APP_PRIVATE_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: |
          echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Environment Setup
        uses: ./.github/actions/environment-setup

      - name: Setup Git User
        run: |
          git config --global user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
          git config --global user.email "${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"

      - name: Docker login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Release (Dry Run)
        if: ${{ inputs.dryRun == true }}
        run: |
          echo "üîç Running dry-run release..."
          # Add your release command here with --dry-run flag
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Run Release
        if: ${{ inputs.dryRun != true }}
        id: release
        run: |
          echo "üöÄ Running release..."
          # Add your release command here
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Extract Release Information
        if: ${{ inputs.dryRun != true }}
        id: release-info
        run: |
          echo "üìã Extracting release information..."

          RELEASE_TAGS=$(git tag --points-at HEAD || echo "")

          if [ -n "$RELEASE_TAGS" ]; then
            echo "released=true" >> "$GITHUB_OUTPUT"
            echo "tags<<EOF" >> "$GITHUB_OUTPUT"
            echo "$RELEASE_TAGS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            
            PROJECTS_JSON=$(echo "$RELEASE_TAGS" | jq -R -s -c 'split("\n") | map(select(length > 0) | split("@") | {project: .[0], version: .[1]}) | map(select(.version != null))')
            echo "projects=$PROJECTS_JSON" >> "$GITHUB_OUTPUT"
            
            echo "üì¶ Released projects:"
            echo "$RELEASE_TAGS" | while read -r tag; do
              echo "  - ${tag}"
            done
          else
            echo "released=false" >> "$GITHUB_OUTPUT"
            echo "projects=[]" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è  No projects were released (no changes detected)"
          fi

      - name: Output Release Summary
        if: always()
        run: |
          echo "### üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dryRun || false }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.dryRun }}" == "true" ]]; then
            echo "‚úÖ **Dry run completed** - No actual releases were created" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.release-info.outputs.released }}" == "true" ]]; then
            echo "**Released Projects:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.release-info.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è  **No releases created** - No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recent Git Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git tag --sort=-version:refname | head -10 >> $GITHUB_STEP_SUMMARY || echo "No tags found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.release.result }}" != "success" ]]; then
            echo "‚ùå Continuous Delivery failed"
            exit 1
          fi

          echo "‚úÖ Continuous Delivery completed successfully!"
